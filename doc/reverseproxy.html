<!DOCTYPE html><html><head><title>Sharry: Reverse Proxy</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="eikek" /><meta name="description" content="Sharry – Share files conveniently" /><meta name="og:image" content="/sharry/img/poster.png" /><meta name="image" property="og:image" content="/sharry/img/poster.png" /><meta name="og:title" content="Sharry: Reverse Proxy" /><meta name="title" property="og:title" content="Sharry: Reverse Proxy" /><meta name="og:site_name" content="Sharry" /><meta name="og:url" content="" /><meta name="og:type" content="website" /><meta name="og:description" content="Sharry – Share files conveniently" /><link rel="icon" type="image/png" href="/sharry/img/favicon.png" /><meta name="twitter:title" content="Sharry: Reverse Proxy" /><meta name="twitter:image" content="/sharry/img/poster.png" /><meta name="twitter:description" content="Sharry – Share files conveniently" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="32x32" href="/sharry/img/favicon-32x32.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/sharry/highlight/styles/vs.css" /><link rel="stylesheet" href="/sharry/css/light-style.css" /><link rel="stylesheet" href="/sharry/css/styles.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/sharry/" class="brand"><div class="brand-wrapper"></div><span>Sharry</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/sharry/doc/" title="Introduction" class="">Introduction</a></div> <div class="sidebar-nav-item  "><a href="/sharry/doc/quickstart" title="Quickstart" class="">Quickstart</a></div> <div class="sidebar-nav-item  open"><a href="/sharry/doc/install" title="Installation" class="drop-nested">Installation</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/sharry/doc/migration" title="Migration" class="">Migration</a> <a href="/sharry/doc/reverseproxy" title="Reverse Proxy" class="active">Reverse Proxy</a> <a href="/sharry/doc/nix" title="Nix/NixOS" class="">Nix/NixOS</a> <a href="/sharry/doc/fail2ban" title="Fail2ban" class="">Fail2ban</a> <a href="/sharry/doc/sharex" title="ShareX" class="">ShareX</a></div></div> <div class="sidebar-nav-item  "><a href="/sharry/doc/configure" title="Configuring" class="">Configuring</a></div> <div class="sidebar-nav-item  "><a href="/sharry/doc/webapp" title="Webapp" class="drop-nested">Webapp</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/sharry/doc/screenshots" title="Screenshots" class="">Screenshots</a></div></div> <div class="sidebar-nav-item  "><a href="/sharry/doc/rest" title="REST Api" class="">REST Api</a></div> <div class="sidebar-nav-item  "><a href="/sharry/doc/dev" title="Development" class="">Development</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="search-nav"><div id="search-dropdown"><label><i class="fa fa-search"></i>Search</label><input id="search-bar" type="text" placeholder="Enter keywords here..." onclick="displayToggleSearch(event)" /><ul id="search-dropdown-content" class="dropdown dropdown-content"></ul></div></li><li id="gh-eyes-item" class="hidden-xs to-uppercase"><a href="https://github.com/eikek/sharry" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs to-uppercase"><a href="https://github.com/eikek/sharry" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="eikek" data-github-repo="sharry"><div class="content-wrapper"><section><h1 id="reverse-proxy">Reverse Proxy</h1>

<p>This contains examples for how to use sharry behind a reverse proxy.</p>

<p>For the examples below, assume the following:</p>

<ul>
  <li>Sharry app is available at <code class="language-plaintext highlighter-rouge">192.168.1.11:9090</code>.</li>
  <li>The external domain/hostname is <code class="language-plaintext highlighter-rouge">sharry.example.com</code></li>
</ul>

<h2 id="configuring-sharry">Configuring Sharry</h2>

<p>These settings require a complement config part in the sharry
configuration file:</p>

<ul>
  <li>
    <p>First, if Sharry REST server is on a different machine, you need to
change the <code class="language-plaintext highlighter-rouge">bind.address</code> setting to be either <code class="language-plaintext highlighter-rouge">0.0.0.0</code> or the ip
address of the network interface that the reverse proxy server
connects to.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sharry.restserver {
  # Where the server binds to.
  bind {
    address = "192.168.1.11"
    port = 9090
  }
}
</code></pre></div>    </div>

    <p>Note that a value of <code class="language-plaintext highlighter-rouge">0.0.0.0</code> instead of <code class="language-plaintext highlighter-rouge">192.168.1.11</code> will bind
the server to every network interface. If it is running on the same
machine as the reverse proxy server, you can set <code class="language-plaintext highlighter-rouge">localhost</code>
instead.</p>
  </li>
  <li>
    <p>Sharry needs to know the external url. The <code class="language-plaintext highlighter-rouge">base-url</code> can be used to
explicitely specify this url. If it is left at its default value,
sharry finds the external url from the request. It is recommended to
set this url, if you have a single external url. Using above values,
it must be set to <code class="language-plaintext highlighter-rouge">https://sharry.example.com</code>.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sharry.restserver {

  # This is the base URL this application is deployed to. This is used
  # to create absolute URLs and to configure the cookie.
  #
  # Note: Currently deploying behind a path is not supported. The URL
  # should not end in a slash.
  base-url = "https://sharry.example.com"
  ...
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>The maximum request size should probably be increased at the reverse
proxy. This depends on your machine, of course. The sharry related
setting is <code class="language-plaintext highlighter-rouge">sharry.restserver.webapp.chunk-size</code>. This defines the
size that is used for uploading chunks of data in one request.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sharry.restserver {
  webapp {
    # Chunk size used for one request. The server will re-chunk the
    # stream into smaller chunks. But the client can transfer more in
    # one requests, resulting in faster uploads.
    #
    # You might need to adjust this value depending on your setup. A
    # higher value usually means faster uploads.
    chunk-size = "100M"
}
</code></pre></div>    </div>

    <p>Here a chunk-size of 100M is used and the reverse proxy must be set
to at least this value. Below it is set to 105M, just to be sure.</p>
  </li>
</ul>

<p>If you have examples for more servers, please let me know or add it to
this site.</p>

<h2 id="nginx">Nginx</h2>

<p>This defines two servers: one listens for http traffic and redirects
to the https variant. Additionally it defines the let’s encrypt
<code class="language-plaintext highlighter-rouge">.well-known</code> folder name. For more information about how to setup
let’s encrypt, please refer to <a href="https://letsencrypt.org/docs/">their
documentation</a> and/or the <a href="https://nginx.org/en/docs/">nginx
documentation</a>.</p>

<p>The https server endpoint is configured with the let’s encrypt
certificates and acts as a proxy for the application at
<code class="language-plaintext highlighter-rouge">192.168.1.11:9090</code>.</p>

<p>The setting <code class="language-plaintext highlighter-rouge">client_max_body_size</code> is relevant, too. This is the
maximum size of a single requests. This must be greater than sharry’s
<code class="language-plaintext highlighter-rouge">webapp.chunk-size</code> setting.</p>

<p>The setting <code class="language-plaintext highlighter-rouge">proxy_buffering off;</code> disables buffering responses from
the application coming to nginx. Buffering may introduce backpressure
problems if the client is not reading fast enough. The response coming
from the application may quickly be too large to fit in memory and
nginx then writes a temporary file (which is limited to 1G by
default). If this limit is reached, nginx waits until the client has
received all disk buffered data which in turn can result in send
timeouts.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 0.0.0.0:80 ;
        listen [::]:80 ;
        server_name subdomain.otherdomain.tld ;
        location /.well-known/acme-challenge {
            root /var/data/nginx/ACME-PUBLIC;
            auth_basic off;
        }
        location / {
            return 301 https://$host$request_uri;
        }
    }
    server {
        listen 0.0.0.0:443 ssl http2 ;
        listen [::]:443 ssl http2 ;
        server_name sharry.example.com ;
        location /.well-known/acme-challenge {
            root /var/data/nginx/ACME-PUBLIC;
            auth_basic off;
        }
        ssl_certificate /var/lib/acme/sharry.example.com/fullchain.pem;
        ssl_certificate_key /var/lib/acme/sharry.example.com/key.pem;
        ssl_trusted_certificate /var/lib/acme/sharry.example.com/full.pem;
        location / {
            proxy_pass http://192.168.1.11:9090;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;

            proxy_set_header    Host                $host;
            proxy_set_header    X-Real-IP           $remote_addr;
            proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header    X-Forwarded-Proto   $scheme;

            proxy_buffering off;
            client_max_body_size 105M;
            proxy_send_timeout   300s;
            proxy_read_timeout   300s;
            send_timeout         300s;
        }
    }
}
</code></pre></div></div>

<h3 id="serving-two-domains">Serving two domains</h3>

<p>This config shows an example to serve nginx on two domains, while the
sharry app is fixed to one domain. This will allow to always use the
same base-url in e-mail templates, while serving the webapp on
different domains.</p>

<p>This is in contrast to the default behaviour (leaving <code class="language-plaintext highlighter-rouge">base-url</code>
setting to its default): the url in mail templates would change
according to the request.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># sharry.conf: base-url = "https://example.org"

map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

# this is the domain as configured in sharry, serve as is
server {
  listen [::]:443 ssl default_server;

  server_name example.org;

  root /srv/http;

  location / {
    # This is the nginx example from the sharry docs
    proxy_pass http://localhost:9090/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    client_max_body_size 105M;
    proxy_send_timeout   300s;
    proxy_read_timeout   300s;
    send_timeout         300s;
  }
}

# this is the second domain as configured in sharry, do the replacing
server {
  listen [::]:80 default_server;

  server_name example.com;

  root /srv/http;

  location / {
    # This is the nginx example from the sharry docs
    proxy_pass http://localhost:9090/;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_buffering off;
    client_max_body_size 105M;
    proxy_send_timeout   300s;
    proxy_read_timeout   300s;
    send_timeout         300s;

    # Replace the protocol/domain in Location headers
    proxy_redirect https://example.org/ http://example.com/;
    # Replace the protocol/domain in the content
    sub_filter_once off;
    sub_filter "https://example.org" "http://example.com";
    sub_filter "example.org" "example.com";
    # sub_filter does not work with gzip, so enforce plaintext
    # see https://www.nginx.com/resources/wiki/modules/substitutions/#subs-filter-types
    proxy_set_header Accept-Encoding "";
  }
}
</code></pre></div></div>
</section></div></div></div></div><script src="/sharry/highlight/highlight.pack.js"></script><script src="/sharry/lunr/lunr.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script src="/sharry/js/fathom.js"></script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/sharry/js/search.js"></script><script src="/sharry/js/docs.js"></script></body></html>